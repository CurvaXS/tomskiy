import{r as I,E as _e,K as B,o as E,t as f,a as d,b as l,w as s,u as t,m as Y,n as Q,i as y,F as j,B as b,g as T,l as Z,q as p,s as G,v as w,x as X,c as h,y as A,h as x,H as z,J as K,a7 as De,z as Ce,S as U,T as F,A as v,a1 as ee,C as Ie,p as te,D as ae,ag as P,a3 as ke,W as Te,a6 as be,U as Me,a5 as Ne,ah as Ve,ai as Se,j as Ae,Z as xe,af as Ue}from"./index-BR7W-eoC.js";import{f as Le,H as Oe,r as Be,I as Fe,J as $e,K as qe,z as He,d as Ke,o as Pe,L as Re}from"./index-nbtYRshG.js";import{_ as ne,u as se,c as le}from"./_plugin-vue_export-helper-Cp86hJrl.js";const ze={key:0,class:"error-message"},Ee={key:1},Ye={__name:"ChatModal",emits:["dismiss","chatCreated"],setup(oe,{emit:R}){const k=R;se();const _=I(!1),c=I(""),C=I([]),r=_e({type:"private",name:"",description:"",participant:null,participants:[]}),$=B(()=>r.type==="private"?r.participant!==null&&r.participant!==void 0:r.name&&r.participants.length>0);E(async()=>{try{C.value=[{id:1,firstName:"Иван",lastName:"Иванов"},{id:2,firstName:"Петр",lastName:"Петров"},{id:3,firstName:"Анна",lastName:"Сидорова"},{id:4,firstName:"Екатерина",lastName:"Смирнова"},{id:5,firstName:"Михаил",lastName:"Кузнецов"}]}catch(g){console.error("Ошибка загрузки пользователей:",g)}});const M=g=>{var o;k("chatCreated",g);try{(o=document.querySelector("ion-modal:last-of-type"))==null||o.dismiss(g)}catch(i){console.error("Ошибка при закрытии модального окна с данными:",i)}},V=async()=>{var g,o;if(!$.value){r.type==="private"&&!r.participant?c.value="Выберите пользователя для чата":r.type==="group"&&(r.name?r.participants.length===0&&(c.value="Добавьте хотя бы одного участника в группу"):c.value="Название группы обязательно для заполнения");return}_.value=!0,c.value="";try{const i={type:r.type};if(r.type==="private"){if(r.participant===null||r.participant===void 0){c.value="Выберите пользователя для чата",_.value=!1;return}i.members=[r.participant]}else i.name=r.name,i.description=r.description,i.members=r.participants;const H=await le.createChat(i);L("Чат успешно создан","success"),M(H.data)}catch(i){c.value=((o=(g=i.response)==null?void 0:g.data)==null?void 0:o.message)||"Ошибка при создании чата",L(c.value,"danger")}finally{_.value=!1}},L=async(g,o="primary")=>{await(await ae.create({message:g,duration:3e3,position:"bottom",color:o})).present()},q=()=>{var g;k("dismiss");try{(g=document.querySelector("ion-modal:last-of-type"))==null||g.dismiss()}catch(o){console.error("Ошибка при закрытии модального окна:",o)}};return(g,o)=>(d(),f(U,null,[l(t(Z),null,{default:s(()=>[l(t(Y),null,{default:s(()=>[l(t(Q),null,{default:s(()=>o[5]||(o[5]=[y("Новый чат")])),_:1}),l(t(j),{slot:"end"},{default:s(()=>[l(t(b),{onClick:q},{default:s(()=>[l(t(T),{slot:"icon-only",icon:t(Le)},null,8,["icon"])]),_:1})]),_:1})]),_:1})]),_:1}),l(t(te),{class:"ion-padding"},{default:s(()=>[p("form",{onSubmit:G(V,["prevent"])},[l(t(X),null,{default:s(()=>[l(t(A),null,{default:s(()=>[l(t(x),null,{default:s(()=>o[6]||(o[6]=[y("Тип чата")])),_:1}),l(t(z),{modelValue:r.type,"onUpdate:modelValue":o[0]||(o[0]=i=>r.type=i),interface:"action-sheet"},{default:s(()=>[l(t(K),{value:"private"},{default:s(()=>o[7]||(o[7]=[y("Личный чат")])),_:1}),l(t(K),{value:"group"},{default:s(()=>o[8]||(o[8]=[y("Групповой чат")])),_:1})]),_:1},8,["modelValue"])]),_:1}),r.type==="group"?(d(),h(t(A),{key:0},{default:s(()=>[l(t(x),{position:"floating"},{default:s(()=>[o[10]||(o[10]=y("Название чата ")),l(t(De),{color:"danger"},{default:s(()=>o[9]||(o[9]=[y("*")])),_:1})]),_:1}),l(t(Ce),{modelValue:r.name,"onUpdate:modelValue":o[1]||(o[1]=i=>r.name=i),required:""},null,8,["modelValue"])]),_:1})):w("",!0),r.type==="private"?(d(),h(t(A),{key:1},{default:s(()=>[l(t(x),null,{default:s(()=>o[11]||(o[11]=[y("Выберите пользователя")])),_:1}),l(t(z),{modelValue:r.participant,"onUpdate:modelValue":o[2]||(o[2]=i=>r.participant=i),interface:"action-sheet"},{default:s(()=>[(d(!0),f(U,null,F(C.value,i=>(d(),h(t(K),{key:i.id,value:i.id},{default:s(()=>[y(v(i.firstName)+" "+v(i.lastName),1)]),_:2},1032,["value"]))),128))]),_:1},8,["modelValue"])]),_:1})):w("",!0),r.type==="group"?(d(),h(t(A),{key:2},{default:s(()=>[l(t(x),null,{default:s(()=>o[12]||(o[12]=[y("Участники")])),_:1}),l(t(z),{modelValue:r.participants,"onUpdate:modelValue":o[3]||(o[3]=i=>r.participants=i),multiple:"",interface:"action-sheet"},{default:s(()=>[(d(!0),f(U,null,F(C.value,i=>(d(),h(t(K),{key:i.id,value:i.id},{default:s(()=>[y(v(i.firstName)+" "+v(i.lastName),1)]),_:2},1032,["value"]))),128))]),_:1},8,["modelValue"])]),_:1})):w("",!0),r.type==="group"?(d(),h(t(A),{key:3},{default:s(()=>[l(t(x),{position:"floating"},{default:s(()=>o[13]||(o[13]=[y("Описание группы")])),_:1}),l(t(ee),{modelValue:r.description,"onUpdate:modelValue":o[4]||(o[4]=i=>r.description=i),rows:"3"},null,8,["modelValue"])]),_:1})):w("",!0)]),_:1}),c.value?(d(),f("div",ze,v(c.value),1)):w("",!0),l(t(b),{expand:"block",type:"submit",disabled:_.value||!$.value},{default:s(()=>[_.value?(d(),h(t(Ie),{key:0,name:"crescent"})):(d(),f("span",Ee,"Создать чат"))]),_:1},8,["disabled"])],32)]),_:1})],64))}},je=ne(Ye,[["__scopeId","data-v-506b101c"]]),Je={key:0},We={class:"chat-last-message"},Qe={class:"chat-meta"},Ze={class:"chat-time"},Ge={key:0,class:"empty-state ion-padding"},Xe={key:1,class:"chat-container"},et={key:0,class:"message-date-divider"},tt={key:0,class:"message-sender"},at={class:"message-content"},nt={class:"message-time"},st={key:1,class:"message-attachment"},lt=["onClick"],ot={key:0,class:"typing-indicator"},rt={class:"message-input-container"},it={__name:"ChatPage",setup(oe){const R=se(),k=B(()=>{var a;return((a=R.user)==null?void 0:a.id)||1}),_=I(""),c=I(null),C=I(""),r=I(null),$=I(!1),M=I([]),V=I([{id:1,chatId:1,content:"Коллеги, добрый день! Напоминаю, что у нас совещание в среду в 15:00.",senderId:2,senderName:"Смирнова О.П.",timestamp:new Date(new Date().getTime()-72e5),read:!0},{id:2,chatId:1,content:"Спасибо за напоминание! Буду обязательно.",senderId:3,senderName:"Иванов К.Н.",timestamp:new Date(new Date().getTime()-36e5),read:!0},{id:3,chatId:1,content:"Коллеги, не забудьте принести отчеты по контрольным работам.",senderId:2,senderName:"Смирнова О.П.",timestamp:new Date(new Date().getTime()-18e5),read:!1},{id:4,chatId:2,content:"Здравствуйте! Подскажите, пожалуйста, расписание на завтра.",senderId:2,senderName:"Петров И.С.",timestamp:new Date(new Date().getTime()-9e4),read:!0},{id:5,chatId:2,content:"Добрый день! У вас первый урок в 9:00, кабинет 305.",senderId:k.value,senderName:"Вы",timestamp:new Date(new Date().getTime()-6e4),read:!0},{id:6,chatId:3,content:"Уважаемые коллеги! Напоминаем о сдаче квартальных отчетов до пятницы.",senderId:5,senderName:"Директор",timestamp:new Date(new Date().getTime()-2592e5),read:!0,attachment:{id:1,name:"Шаблон отчета.docx",type:"docx",url:"/files/report-template.docx"}},{id:7,chatId:3,content:"Также не забудьте внести данные по успеваемости в систему.",senderId:5,senderName:"Директор",timestamp:new Date(new Date().getTime()-1728e5),read:!1}]),L=B(()=>{if(!_.value)return M.value;const a=_.value.toLowerCase();return M.value.filter(e=>e.name.toLowerCase().includes(a)||e.lastMessage.toLowerCase().includes(a))}),q=B(()=>c.value?V.value.filter(a=>a.chatId===c.value.id).sort((a,e)=>new Date(a.timestamp)-new Date(e.timestamp)):[]),g=B(()=>{if(!q.value.length)return[];const a=[];let e=null,n=[];return q.value.forEach(m=>{const u=new Date(m.timestamp).setHours(0,0,0,0);e!==u?(n.length>0&&a.push({date:e,messages:n}),e=u,n=[m]):n.push(m)}),n.length>0&&a.push({date:e,messages:n}),a}),o=a=>{c.value=a,a.unreadCount=0,P(()=>{O()})},i=()=>{c.value=null},H=()=>{if(!C.value.trim())return;const a={id:V.value.length+1,chatId:c.value.id,content:C.value.trim(),senderId:k.value,senderName:"Вы",timestamp:new Date,read:!1};V.value.push(a);const e=M.value.find(n=>n.id===c.value.id);e&&(e.lastMessage=a.content,e.lastMessageTime=a.timestamp),C.value="",P(()=>{O()})},re=async()=>{try{const a=await le.getChats();if(console.log("Response from server:",a.data),!a.data||!a.data.chats){console.error("Неожиданный формат ответа API:",a.data);return}M.value=a.data.chats.map(e=>{var m,u,D,N;let n=e.name;if(e.type==="private"&&!n){const S=(m=e.members)==null?void 0:m.find(we=>we.id!==k.value);n=S?S.name:"Личный чат"}else n||(n="Групповой чат");return{id:e.id,name:n,type:e.type,participants:((u=e.members)==null?void 0:u.map(S=>S.id))||[],lastMessage:((D=e.lastMessage)==null?void 0:D.content)||"",lastMessageTime:(N=e.lastMessage)!=null&&N.createdAt?new Date(e.lastMessage.createdAt):null,unreadCount:e.unreadCount||0,createdAt:e.createdAt?new Date(e.createdAt):new Date}})}catch(a){console.error("Ошибка при загрузке чатов:",a),W("Ошибка при загрузке чатов","danger")}},J=async()=>{const a=await xe.create({component:je});a.onDidDismiss().then(async({data:e})=>{var n,m;if(e){let u=e.name;if(e.type==="private"&&!u){const N=(n=e.members)==null?void 0:n.find(S=>S.id!==k.value);u=N?N.name:"Личный чат"}else u||(u="Групповой чат");const D={id:e.id,name:u,type:e.type,participants:((m=e.members)==null?void 0:m.map(N=>N.id))||[],lastMessage:"",lastMessageTime:e.createdAt?new Date(e.createdAt):new Date,unreadCount:0,createdAt:e.createdAt?new Date(e.createdAt):new Date};M.value.unshift(D),W("Чат успешно создан","success")}}),await a.present()},ie=()=>{alert(`Информация о чате: ${c.value.name}`)},ue=async()=>{await(await Ue.create({header:"Прикрепить файл",buttons:[{text:"Фото или видео",handler:()=>{}},{text:"Документ",handler:()=>{}},{text:"Отмена",role:"cancel"}]})).present()},de=a=>{alert(`Открытие файла: ${a.name}`)},ce=()=>{},O=()=>{if(r.value){const a=r.value;a.scrollTop=a.scrollHeight}};E(async()=>{await re(),r.value&&O()});const me=a=>new Date(a).toLocaleTimeString("ru-RU",{hour:"2-digit",minute:"2-digit"}),pe=a=>{const e=new Date(a),n=new Date,m=new Date(n.getFullYear(),n.getMonth(),n.getDate()),u=new Date(m);u.setDate(u.getDate()-1);const D=new Date(e.getFullYear(),e.getMonth(),e.getDate());return D.getTime()===m.getTime()?"Сегодня":D.getTime()===u.getTime()?"Вчера":e.toLocaleDateString("ru-RU",{day:"numeric",month:"long",year:"numeric"})},fe=a=>{if(!a)return"";const e=a instanceof Date?a:new Date(a);if(isNaN(e.getTime()))return"";const n=new Date,m=new Date(n.getFullYear(),n.getMonth(),n.getDate()),u=new Date(m);u.setDate(u.getDate()-1);const D=new Date(e.getFullYear(),e.getMonth(),e.getDate());return D.getTime()===m.getTime()?e.toLocaleTimeString("ru-RU",{hour:"2-digit",minute:"2-digit"}):D.getTime()===u.getTime()?"Вчера":e.toLocaleDateString("ru-RU",{day:"numeric",month:"short"})},ve=(a,e)=>e===0||a.date!==g.value[e-1].date,ge=a=>a?a.split(" ").map(e=>e[0]).join("").toUpperCase().substring(0,2):"ЧТ",ye=a=>{const e=["#3880ff","#5260ff","#2dd36f","#ffc409","#eb445a","#92949c"];return e[a%e.length]},he=()=>_.value?`Нет чатов, соответствующих запросу "${_.value}"`:"У вас пока нет открытых чатов";E(async()=>{try{P(()=>{O()})}catch(a){console.error("Failed to load chat data:",a)}});const W=async(a,e="primary")=>{await(await ae.create({message:a,duration:3e3,position:"bottom",color:e})).present()};return ke(V,()=>{P(()=>{O()})}),(a,e)=>(d(),h(t(Ae),null,{default:s(()=>[l(t(Z),null,{default:s(()=>[l(t(Y),null,{default:s(()=>[c.value?(d(),h(t(j),{key:0,slot:"start"},{default:s(()=>[l(t(b),{onClick:i},{default:s(()=>[l(t(T),{slot:"icon-only",icon:t(Oe)},null,8,["icon"])]),_:1})]),_:1})):w("",!0),l(t(Q),null,{default:s(()=>[y(v(c.value?c.value.name:"Чаты"),1)]),_:1}),l(t(j),{slot:"end"},{default:s(()=>[c.value?(d(),h(t(b),{key:1,onClick:ie},{default:s(()=>[l(t(T),{slot:"icon-only",icon:t(Fe)},null,8,["icon"])]),_:1})):(d(),h(t(b),{key:0,onClick:J},{default:s(()=>[l(t(T),{slot:"icon-only",icon:t(Be)},null,8,["icon"])]),_:1}))]),_:1})]),_:1})]),_:1}),l(t(te),null,{default:s(()=>[c.value?(d(),f("div",Xe,[p("div",{class:"messages-container",ref_key:"messagesContainer",ref:r},[(d(!0),f(U,null,F(g.value,(n,m)=>(d(),f("div",{key:m,class:"message-group"},[ve(n,m)?(d(),f("div",et,v(pe(n.date)),1)):w("",!0),(d(!0),f(U,null,F(n.messages,u=>(d(),f("div",{key:u.id,class:Ne(["message-bubble",{"my-message":u.senderId===k.value}])},[!u.isMyMessage&&n.messages[0].id===u.id?(d(),f("div",tt,v(u.senderName),1)):w("",!0),p("div",at,[y(v(u.content)+" ",1),p("div",nt,[y(v(me(u.timestamp))+" ",1),u.senderId===k.value?(d(),h(t(T),{key:0,icon:u.read?t(qe):t(He),class:"message-status-icon"},null,8,["icon"])):w("",!0)])]),u.attachment?(d(),f("div",st,[p("div",{class:"attachment-preview",onClick:D=>de(u.attachment)},[l(t(T),{icon:t(Ke)},null,8,["icon"]),p("span",null,v(u.attachment.name),1)],8,lt)])):w("",!0)],2))),128))]))),128)),$.value?(d(),f("div",ot,e[4]||(e[4]=[p("div",{class:"typing-dot"},null,-1),p("div",{class:"typing-dot"},null,-1),p("div",{class:"typing-dot"},null,-1)]))):w("",!0)],512)])):(d(),f("div",Je,[l(t(Te),{placeholder:"Поиск чатов",modelValue:_.value,"onUpdate:modelValue":e[0]||(e[0]=n=>_.value=n),onIonInput:ce},null,8,["modelValue"]),l(t(X),{lines:"full"},{default:s(()=>[(d(!0),f(U,null,F(L.value,n=>(d(),h(t(A),{button:"",key:n.id,onClick:m=>o(n),class:"chat-item"},{default:s(()=>[p("div",{class:"chat-avatar",slot:"start",style:be({backgroundColor:ye(n.id)})},v(ge(n.name)),5),l(t(x),null,{default:s(()=>[p("h2",null,v(n.name),1),p("p",We,v(n.lastMessage),1)]),_:2},1024),p("div",Qe,[p("span",Ze,v(fe(n.lastMessageTime)),1),n.unreadCount>0?(d(),h(t(Me),{key:0},{default:s(()=>[y(v(n.unreadCount),1)]),_:2},1024)):w("",!0)])]),_:2},1032,["onClick"]))),128))]),_:1}),L.value.length===0?(d(),f("div",Ge,[l(t(T),{icon:t($e),class:"empty-icon"},null,8,["icon"]),e[3]||(e[3]=p("h3",null,"Нет чатов",-1)),p("p",null,v(he()),1),l(t(b),{onClick:J},{default:s(()=>e[2]||(e[2]=[y("Создать чат")])),_:1})])):w("",!0)]))]),_:1}),c.value?(d(),h(t(Ve),{key:0},{default:s(()=>[l(t(Y),null,{default:s(()=>[p("div",rt,[l(t(b),{fill:"clear",onClick:ue},{default:s(()=>[l(t(T),{slot:"icon-only",icon:t(Pe)},null,8,["icon"])]),_:1}),l(t(ee),{modelValue:C.value,"onUpdate:modelValue":e[1]||(e[1]=n=>C.value=n),placeholder:"Написать сообщение...","auto-grow":!0,class:"message-input",onKeydown:Se(G(H,["prevent"]),["enter"])},null,8,["modelValue","onKeydown"]),l(t(b),{fill:"clear",onClick:H,disabled:!C.value.trim()},{default:s(()=>[l(t(T),{slot:"icon-only",icon:t(Re)},null,8,["icon"])]),_:1},8,["disabled"])])]),_:1})]),_:1})):w("",!0)]),_:1}))}},mt=ne(it,[["__scopeId","data-v-496717b5"]]);export{mt as default};
